<!DOCTYPE html>
<html lang="zh">
    <head>
        <script src="https://unpkg.com/vue/dist/vue.js"></script>
        <script src="https://unpkg.com/vue-infinite-scroll@2.0.0"></script>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script src="../../js/base.js"></script>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="moqunzhu">

        <title>日历</title>
        <!-- WeUI styles -->
        <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/1.1.0/weui.min.css">

        <!-- Custom styles -->
        <link href="../../css/weui-calendar.css" rel="stylesheet">
        <link href="../../css/weui-custom-style.css" rel="stylesheet">
        

        <!-- WeUI Javascript library -->
        <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>

    </head>

<body>
    <div id="vue-container">
        <div class="calendar-wrapper">
            <div class="calendar-container" id="month-view" v-if="view === 'month' && initialized">
                <div class="header-warper"> 
                    <h1 class="news-title">{{ focus_day.getMonth()+1 }}月<span style="font-size:16px;"> {{ focus_day.getYear()+1900 }}年</h1>
                    <div id="views-switcher">
                        <span class="switcher weui-btn weui-btn_primary" id="month-switch">月</span>
                        <span class="switcher weui-btn weui-btn_default" id="week-switch">周</span>
                    </div>
                </div>
                
                <div class="weui-grids">
                     <div class="days-bar">一</div>
                     <div class="days-bar">二</div>
                     <div class="days-bar">三</div>
                     <div class="days-bar">四</div>
                     <div class="days-bar">五</div>
                     <div class="days-bar">六</div>
                     <div class="days-bar">日</div>
                </div>
                <div class="month-content weui-grids">
                    <div class="weui-grid" v-for="i in margin.before"></div>
                    <div class="weui-grid" v-for="date in num_dates" v-on:click="show_detail" v-bind:id="date">
                        <div class="date_content_wrapper">
                            <div class="date_label" v-if="date === current_day.getDate()"><span class="today_label">{{ date }}</span></div>
                            <div class="date_label" v-else>{{ date }}</div>
                            <div class="scroll-list">
                                <!-- course dot -->
                                <p  class="weui-grid__label" >
                                    <span class="course_badge weui-badge weui-badge_dot" v-for="item in course[date-1]"></span>
                                </p>

                                <!-- homework dot -->
                                <p  class="weui-grid__label" >
                                    <span class="event_badge weui-badge weui-badge_dot" v-for="item in notice[date-1]"></span>
                                </p>
                                <p  class="weui-grid__label" >
                                    <span class="hw_badge weui-badge weui-badge_dot" v-for="item in hw[date-1]"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="weui-grid" v-for="i in margin.after"></div>
                </div>


                <!-- Detail Dialog -->
                <transition id="dialog-container" name="fade">
                    <div v-if="detail_showing" class="detail-dialog">
                        <div class="weui-mask"></div>
                        <div class="scheduler-dialog weui-dialog">
                            <div class="dialog-title">{{ selected_day.getDate() }}日<span style="font-size:16px;">{{ selected_day.getMonth()+1 }}月{{ selected_day.getYear()+1900 }}年</span></div>
                            <div class="dialog-detail-box">
                                <table>
                                    <tr class="time-row" v-for="time in 16">
                                        <td class="time-mark">{{time+7}}:00</td>
                                        <td class="time-content"></td>
                                    </tr>
                                    <tr class="time-row" >
                                        <td class="time-mark">ddls:</td>
                                        <td class="time-content">
                                            <div class="block hw-block" v-for="c, index in selected_day_hw" >
                                                <div class="block-title">{{ c.title }}</div>
                                                <div class="block-info">{{c.course_name}}</div> 
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="time-row" >
                                        <td class="time-mark">events:</td>
                                        <td class="time-content">
                                            <div class="block event-block" v-for="c, index in selected_day_notice" >
                                                <div class="block-title">{{ c.title }}</div> 
                                            </div>
                                        </td>
                                    </tr>
                                </table>

                                <div class="block course-block" v-for="c in selected_day_course" :style="{top: c.top+'px', height: c.height+'px'}">
                                    <div class="block-title">{{ c.title }}</div>
                                    <div class="block-subtitle">{{c.start_time.hour}}:{{c.start_time.min}} - {{c.end_time.hour}}:{{c.end_time.min}}</div>
                                    <div class="block-info">{{c.location}}</div> 
                                </div>

                                <div class="current-time" v-if="current_day.getDate() === selected_day.getDate()&& current_day.getMonth() === selected_day.getMonth() && current_day.getHours()>=8">
                                    <div class="current-time-line"  :style="{top: (current_day.getHours()-8)*60+current_day.getMinutes()+3 + 'px'}"></div>
                                    <div class="current-time-dot" :style="{top: (current_day.getHours()-8)*60+current_day.getMinutes()-3 + 'px'}"></div>
                                </div>
                                
                            </div>


                            <div class="weui-dialog__ft" style="text-align: center;">
                                <a v-on:click="hide_detail" class="weui-dialog__btn weui-dialog__btn_primary">返回</a>
                            </div>
                        </div>
                    </div>
                </transition>

            </div>
            <div class="calendar-container" id="week-view" style="display:none;"></div>
            <div class="weui-loadmore" v-if="!initialized">
                <i class="weui-loading"></i>
                <span class="weui-loadmore__tips">正在加载</span>
            </div>
        </div>
    </div>

    <script>

        var vm = new Vue({
            el: '#vue-container',
            data: {
                'hw': [],
                'course': [],
                'notice': [],
                'initialized': false,
                'view': 'month',            // calendar view switcher
                'current_day': today,
                'focus_day': today,         // today or the firstday of the month to display
                'urlParam': urlParam,
                'num_dates': 0,             // number of days in the focused month
                'margin': {},               // for the alignment of dates and days
                'detail_showing': false,
                'selected_day': today,
                'selected_day_course': [],  // course data for detail-dialog
                'selected_day_hw': [],      // hw data for detail-dialog
                'selected_day_notice': []
            },
            methods: {
                init: function() {
                    var _vm = this;
                    var param = month_range(today);
                    _vm.num_dates = new Date(today.getYear()+1900, today.getMonth()+1, 0).getDate();
                    _vm.margin = calculate_margin(today);
                    // Get academic calendar
                    getJSON('/api/cal/personal', param, function(data) {
                        raw_data = data;
                        if (raw_data.code == 0) {
                             _vm.course  = schedule(raw_data.data, _vm.num_dates, today.getMonth());
                        }
                        else {
                            // TODO
                        }
                        // Get important notice
                        getJSON('/api/cal/global', function(data) {
                            raw_data = data;
                            if (raw_data.code == 0) {
                                 _vm.notice  = schedule(raw_data.data, _vm.num_dates, today.getMonth());
                            }
                            else {
                                // TODO
                            }
                            getJSON('/api/hw/list', param, function(data) {
                                raw_data = data;
                                if (raw_data.code == 0) {
                                     _vm.hw  = schedule(raw_data.data, _vm.num_dates, today.getMonth());
                                }
                                _vm.initialized = true;
                            });

                        });
                       
                    });
                },
                update: function() {
                    var _vm = this;
                    year = today.getYear() + 1900;
                    month = today.getMonth();
                    _vm.num_dates = new Date(year, month+1, 0).getDate();
                    _vm.margin.before = new Date(year, month, 1).getDay() - 1;
                    _vm.margin.after = 7 - new Date(year, month+1, 0).getDay();
                },
                load_more: function() {},  // TODO
                hide_detail: function() {
                    this.detail_showing = false;
                },
                show_detail: function(ev) {
                    var _vm = this;
                    var date = ev.currentTarget.id;
                    var month = _vm.focus_day.getMonth();
                    var year = _vm.focus_day.getYear() + 1900;

                    _vm.selected_day = new Date(year, month, date);

                    course_data = _vm.course[date-1];
                    hw_data = _vm.hw[date-1];
                    notice_data = _vm.notice[date-1];
                    
                    produce_course_block(course_data);
                    _vm.selected_day_course = course_data;
                    _vm.selected_day_hw = hw_data;
                    _vm.selected_day_notice = notice_data;
                    _vm.detail_showing = true;

                },
            }
        }); 
        vm.init();

    </script>
</body>
</html>
